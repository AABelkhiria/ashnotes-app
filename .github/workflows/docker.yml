name: 'Build and Push Docker Image'

on:
  workflow_dispatch

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Setup upterm session
        uses: lhotari/action-upterm@v1

      - name: Get latest Docker image tag from GHCR and increment version
        id: versioning
        run: |
          package="aabelkhiria/tauri-build-env"
          current_date=$(date +'%y.%m')
          # Fetch tags from GHCR
          tags=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://ghcr.io/v2/${package}/tags/list" | jq -r '.tags[]' | grep -E '^[0-9]{2}\.[0-9]{2}\.[0-9]+$' || true)
          echo "tags=$tags"
          # Get latest tag for current month
          latest_tag=$(echo "$tags" | grep "^$current_date\." | sort -V | tail -n 1)
          if [ -n "$latest_tag" ]; then
            minor_version=$(echo "$latest_tag" | cut -d. -f3)
            new_minor=$((minor_version + 1))
            new_version="$current_date.$new_minor"
          else
            new_version="$current_date.1"
          fi
          echo "latest_tag=$latest_tag"
          echo "new_version=$new_version"
          echo "new_version=$new_version" >> $GITHUB_OUTPUT

      - name: Set lowercase repo owner
        id: repo-owner
        run: echo "owner=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./.docker/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ steps.repo-owner.outputs.owner }}/tauri-build-env:latest
            ghcr.io/${{ steps.repo-owner.outputs.owner }}/tauri-build-env:${{ steps.versioning.outputs.new_version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
